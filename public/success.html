<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Confirmado - DriveSkore</title>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; padding: 20px;">
  <div style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
    <img src="/logo.png" style="width: 280px; height: auto; margin-bottom: 20px;">
    <div id="checkmark" style="font-size: 60px; margin-bottom: 20px;">‚è≥</div>
    <h1 id="title" style="font-size: 32px; margin-bottom: 16px; color: #1a1a1a;">Verificando email...</h1>
    <p id="message" style="font-size: 16px; color: #666; margin-bottom: 30px;">Por favor espera un momento...</p>
    <div id="actions" style="display: none;">
      <a id="openApp" href="driveskore://" style="display: inline-block; background: #007AFF; color: white; padding: 16px 40px; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 18px; margin: 10px;">Abrir DriveSkore</a>
    </div>
    <p style="font-size: 13px; color: #999; margin-top: 25px;">¬øNo tienes la app? <a href="https://driveskore.vercel.app" style="color: #007AFF;">Desc√°rgala aqu√≠</a></p>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const supabase = createClient(
      'https://dfpwfkeeapdbnetkyzwi.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmcHdma2VlYXBkYm5ldGt5endpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxMzcyMTAsImV4cCI6MjA3NTcxMzIxMH0.P6ENMwmG4dju4CeHcWoOWZELtSIYWIEpKiqbSjsrQ98'
    )

    async function handleEmailVerification() {
      try {
        console.log('üîç Iniciando verificaci√≥n de email...')
        console.log('üìç URL completa:', window.location.href)
        
        // M√âTODO 1: Intentar con verifyOtp (para el flujo PKCE con token en URL)
        const urlParams = new URLSearchParams(window.location.search)
        const token = urlParams.get('token')
        const type = urlParams.get('type')
        
        console.log('üìã Par√°metros de URL:')
        console.log('  - token:', token ? 'Presente ('+token.substring(0,20)+'...)' : 'AUSENTE')
        console.log('  - type:', type)

        if (token && type === 'signup') {
          console.log('‚úÖ Flujo PKCE detectado, verificando token...')
          
          // Verificar el token con Supabase
          const { data, error } = await supabase.auth.verifyOtp({
            token_hash: token,
            type: 'signup'
          })

          if (error) {
            console.error('‚ùå Error verificando OTP:', error)
            throw error
          }

          console.log('‚úÖ Email verificado exitosamente:', data)
          
          // Actualizar UI
          document.getElementById('checkmark').textContent = '‚úÖ'
          document.getElementById('title').textContent = '¬°Email Confirmado!'
          document.getElementById('message').textContent = 'Tu cuenta ha sido verificada. Ya puedes iniciar sesi√≥n en DriveSkore.'
          document.getElementById('actions').style.display = 'block'
          
          // Intentar abrir la app despu√©s de 2 segundos
          setTimeout(() => {
            console.log('üì± Abriendo app...')
            window.location.href = 'driveskore://'
          }, 2000)
          
          return
        }

        // M√âTODO 2: Intentar con tokens en el hash (flujo legacy)
        const hashParams = new URLSearchParams(window.location.hash.substring(1))
        const accessToken = hashParams.get('access_token')
        const refreshToken = hashParams.get('refresh_token')
        const hashType = hashParams.get('type')

        console.log('üìã Par√°metros de hash:')
        console.log('  - type:', hashType)
        console.log('  - accessToken:', accessToken ? 'Presente' : 'AUSENTE')
        console.log('  - refreshToken:', refreshToken ? 'Presente' : 'AUSENTE')

        if (hashType === 'signup' && accessToken && refreshToken) {
          console.log('‚úÖ Flujo legacy detectado, estableciendo sesi√≥n...')
          
          const { data, error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
          })

          if (error) {
            console.error('‚ùå Error estableciendo sesi√≥n:', error)
            throw error
          }

          console.log('‚úÖ Sesi√≥n establecida:', data)
          
          // Actualizar UI
          document.getElementById('checkmark').textContent = '‚úÖ'
          document.getElementById('title').textContent = '¬°Email Confirmado!'
          document.getElementById('message').textContent = 'Tu cuenta ha sido verificada. Ya puedes usar DriveSkore.'
          document.getElementById('actions').style.display = 'block'
          
          // Abrir app
          setTimeout(() => {
            console.log('üì± Abriendo app...')
            window.location.href = 'driveskore://'
          }, 2000)
          
          return
        }

        // Si llegamos aqu√≠, no se pudo verificar con ning√∫n m√©todo
        console.error('‚ùå No se encontraron par√°metros v√°lidos en la URL')
        document.getElementById('checkmark').textContent = '‚ùå'
        document.getElementById('title').textContent = 'Link inv√°lido'
        document.getElementById('message').textContent = 'El enlace de verificaci√≥n no es v√°lido o ya expir√≥. Por favor, reg√≠strate de nuevo.'
        
      } catch (error) {
        console.error('‚ùå Error completo:', error)
        document.getElementById('checkmark').textContent = '‚ùå'
        document.getElementById('title').textContent = 'Error'
        document.getElementById('message').textContent = error.message || 'Error al verificar email. Por favor, intenta registrarte de nuevo.'
      }
    }

    // Ejecutar verificaci√≥n al cargar la p√°gina
    handleEmailVerification()
  </script>
</body>
</html>